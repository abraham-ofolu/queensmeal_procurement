{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h3 class="mb-3">Reports</h3>

  <!-- Filters -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Start Date</label>
      <input type="date" name="start_date" class="form-control" value="{{ filters.start_date }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">End Date</label>
      <input type="date" name="end_date" class="form-control" value="{{ filters.end_date }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">Paid By</label>
      <select name="paid_by_role" class="form-select">
        <option value="all" {% if filters.role == "all" %}selected{% endif %}>All</option>
        <option value="director" {% if filters.role == "director" %}selected{% endif %}>Director</option>
        <option value="finance" {% if filters.role == "finance" %}selected{% endif %}>Finance</option>
      </select>
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary me-2">Apply</button>
      <a class="btn btn-outline-secondary"
         href="{{ url_for('reports.export_csv', **filters) }}">
        Export CSV
      </a>
    </div>
  </form>

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    {% for label, value in [
      ("Total Requests", kpis.total_requests),
      ("Approved", kpis.approved_requests),
      ("Pending", kpis.pending_requests),
      ("Rejected", kpis.rejected_requests)
    ] %}
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">{{ label }}</div>
          <div class="fs-4 fw-bold">{{ value }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="mb-4">
    <strong>Total Paid:</strong> ₦ {{ "{:,.2f}".format(kpis.total_paid) }}
  </div>

  <!-- Charts -->
  <div class="row g-4">
    <div class="col-lg-6">
      <canvas id="reqChart"></canvas>
    </div>
    <div class="col-lg-6">
      <canvas id="roleChart"></canvas>
    </div>
    <div class="col-lg-12">
      <canvas id="monthChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(reqChart, {
  type: "bar",
  data: { labels: {{ charts.requests_daily.labels|tojson }},
          datasets: [{ label: "Requests", data: {{ charts.requests_daily.values|tojson }} }] }
});

new Chart(roleChart, {
  type: "pie",
  data: { labels: {{ charts.payments_by_role.labels|tojson }},
          datasets: [{ data: {{ charts.payments_by_role.values|tojson }} }] }
});

new Chart(monthChart, {
  type: "line",
  data: { labels: {{ charts.monthly_spend.labels|tojson }},
          datasets: [{ label: "₦ Paid", data: {{ charts.monthly_spend.values|tojson }} }] }
});
</script>
{% endblock %}
