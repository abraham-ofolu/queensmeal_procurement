{% extends "base.html" %}

{% block content %}
<h3 class="mb-3">Reports Dashboard</h3>

<!-- Filters -->
<form method="get" class="row g-3 mb-4">
  <div class="col-md-3">
    <label>Start Date</label>
    <input type="date" name="start_date" value="{{ filters.start_date }}" class="form-control">
  </div>

  <div class="col-md-3">
    <label>End Date</label>
    <input type="date" name="end_date" value="{{ filters.end_date }}" class="form-control">
  </div>

  <div class="col-md-3">
    <label>Paid By Role</label>
    <select name="paid_by_role" class="form-select">
      <option value="all" {% if filters.role == "all" %}selected{% endif %}>All</option>
      <option value="finance" {% if filters.role == "finance" %}selected{% endif %}>Finance</option>
      <option value="director" {% if filters.role == "director" %}selected{% endif %}>Director</option>
    </select>
  </div>

  <div class="col-md-3 d-flex align-items-end">
    <button class="btn btn-primary w-100">Apply Filters</button>
  </div>
</form>

<!-- KPIs -->
<div class="row mb-4">
  <div class="col-md-2"><div class="card p-3">Total Requests<br><b>{{ kpis.total_requests }}</b></div></div>
  <div class="col-md-2"><div class="card p-3">Approved<br><b>{{ kpis.approved_requests }}</b></div></div>
  <div class="col-md-2"><div class="card p-3">Pending<br><b>{{ kpis.pending_requests }}</b></div></div>
  <div class="col-md-2"><div class="card p-3">Rejected<br><b>{{ kpis.rejected_requests }}</b></div></div>
  <div class="col-md-2"><div class="card p-3">Total Paid<br><b>â‚¦{{ "{:,.2f}".format(kpis.total_paid) }}</b></div></div>
</div>

<!-- Charts -->
<div class="row">
  <div class="col-md-6">
    <canvas id="requestsChart"></canvas>
  </div>
  <div class="col-md-6">
    <canvas id="paymentsRoleChart"></canvas>
  </div>
</div>

<div class="row mt-4">
  <div class="col-md-12">
    <canvas id="monthlySpendChart"></canvas>
  </div>
</div>

<!-- Export -->
<div class="mt-4">
  <a class="btn btn-success"
     href="{{ url_for('reports.export_csv',
        start_date=filters.start_date,
        end_date=filters.end_date,
        paid_by_role=filters.role) }}">
    Export CSV
  </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
new Chart(document.getElementById("requestsChart"), {
  type: "line",
  data: {
    labels: {{ charts.requests_daily["labels"] | tojson }},
    datasets: [{
      label: "Requests",
      data: {{ charts.requests_daily["values"] | tojson }},
      borderWidth: 2
    }]
  }
});

new Chart(document.getElementById("paymentsRoleChart"), {
  type: "pie",
  data: {
    labels: {{ charts.payments_by_role["labels"] | tojson }},
    datasets: [{
      data: {{ charts.payments_by_role["values"] | tojson }}
    }]
  }
});

new Chart(document.getElementById("monthlySpendChart"), {
  type: "bar",
  data: {
    labels: {{ charts.monthly_spend["labels"] | tojson }},
    datasets: [{
      label: "Monthly Spend",
      data: {{ charts.monthly_spend["values"] | tojson }}
    }]
  }
});
</script>
{% endblock %}
