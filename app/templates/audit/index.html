{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width: 1100px;">
  <h2 style="margin-top: 10px;">Audit Trail</h2>
  <p style="opacity: 0.8;">Shows latest actions across the system (limit 500).</p>

  <form method="get" style="display:flex; gap:12px; align-items:flex-end; margin-bottom: 16px;">
    <div style="flex: 1;">
      <label>Entity Type</label>
      <input class="form-control" name="entity_type" value="{{ entity_type }}" placeholder="e.g. ProcurementRequest">
    </div>
    <div style="width: 200px;">
      <label>Action</label>
      <select class="form-control" name="action">
        <option value="" {% if not action %}selected{% endif %}>All</option>
        <option value="create" {% if action=='create' %}selected{% endif %}>create</option>
        <option value="update" {% if action=='update' %}selected{% endif %}>update</option>
        <option value="delete" {% if action=='delete' %}selected{% endif %}>delete</option>
      </select>
    </div>
    <div>
      <button class="btn btn-primary" type="submit">Filter</button>
      <a class="btn btn-secondary" href="{{ url_for('audit.index') }}">Reset</a>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Time</th>
          <th>Action</th>
          <th>Entity</th>
          <th>Actor</th>
          <th>Role</th>
          <th>IP</th>
          <th>Changes</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.created_at }}</td>
          <td><b>{{ log.action }}</b></td>
          <td>
            {{ log.entity_type }}:
            {% if log.entity_type == 'ProcurementRequest' and log.entity_id %}
              <a href="{{ url_for('audit.request_timeline', request_id=log.entity_id|int) }}">#{{ log.entity_id }}</a>
            {% else %}
              {{ log.entity_id }}
            {% endif %}
          </td>
          <td>{{ log.actor_name or '-' }}</td>
          <td>{{ log.actor_role or '-' }}</td>
          <td style="max-width: 170px; word-break: break-word;">{{ log.ip_address or '-' }}</td>
          <td style="max-width: 380px; word-break: break-word;">
            {% if log.changes %}
              <code>{{ log.changes }}</code>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if logs|length == 0 %}
        <tr><td colspan="7">No audit logs yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
