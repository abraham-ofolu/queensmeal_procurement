{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

  <h3 class="mb-3">Procurement Request Details</h3>

  <div class="card mb-4">
    <div class="card-body">
      <p><strong>Title:</strong> {{ pr.title }}</p>
      <p><strong>Description:</strong> {{ pr.description }}</p>
      <p><strong>Amount:</strong> ₦{{ "{:,.2f}".format(pr.amount) }}</p>
      <p><strong>Status:</strong> {{ pr.status|upper }}</p>

      {% if pr.vendor %}
      <hr>
      <h5>Vendor Details</h5>
      <p><strong>Name:</strong> {{ pr.vendor.name }}</p>
      <p><strong>Bank:</strong> {{ pr.vendor.bank_name }}</p>
      <p><strong>Account Name:</strong> {{ pr.vendor.account_name }}</p>
      <p><strong>Account Number:</strong> {{ pr.vendor.account_number }}</p>
      {% endif %}

      {% if pr.quotation %}
      <hr>
      <h5>Quotation</h5>

      <button class="btn btn-sm btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#filePreviewModal"
              data-file-url="{{ url_for('procurement.view_quotation', filename=pr.quotation) }}">
        View Quotation
      </button>
      {% else %}
      <p class="text-muted">No quotation uploaded.</p>
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2 mb-4">
    <a href="{{ url_for('finance.make_payment', request_id=pr.id) }}"
       class="btn btn-success">
      Record Payment
    </a>

    <a href="{{ url_for('procurement.list_requests') }}"
       class="btn btn-secondary">
      Back
    </a>
  </div>

  <hr>

  <h4>Payments</h4>

  {% if pr.payments %}
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Date</th>
        <th>Amount</th>
        <th>Method</th>
        <th>Receipt</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in pr.payments %}
      <tr>
        <td>{{ p.paid_at.strftime("%d %b %Y %H:%M") }}</td>
        <td>₦{{ "{:,.2f}".format(p.amount) }}</td>
        <td>{{ p.method }}</td>
        <td>
          {% if p.receipt %}
          <button class="btn btn-sm btn-outline-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#filePreviewModal"
                  data-file-url="{{ p.receipt }}">
            View
          </button>
          {% else %}
          <span class="text-muted">None</span>
          {% endif %}
        </td>
        <td>
          {% if p.receipt %}
          <form method="POST"
                action="{{ url_for('finance.delete_receipt', payment_id=p.id) }}"
                style="display:inline;">
            <button class="btn btn-sm btn-danger"
                    onclick="return confirm('Delete receipt?')">
              Delete
            </button>
          </form>
          {% endif %}

          <form method="POST"
                action="{{ url_for('finance.upload_receipt', payment_id=p.id) }}"
                enctype="multipart/form-data"
                style="display:inline;">
            <input type="file" name="receipt" required hidden id="r{{ p.id }}">
            <button type="button"
                    class="btn btn-sm btn-warning"
                    onclick="document.getElementById('r{{ p.id }}').click()">
              Re-upload
            </button>
            <button type="submit" class="btn btn-sm btn-success">
              Save
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-muted">No payments recorded.</p>
  {% endif %}

</div>

<!-- FILE PREVIEW MODAL -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">File Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <iframe id="filePreviewFrame"
                src=""
                style="width:100%; height:70vh; border:none;"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('filePreviewModal')
  .addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const url = button.getAttribute('data-file-url');
    document.getElementById('filePreviewFrame').src = url;
  });
</script>

{% endblock %}
