{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h3>Procurement Request Details</h3>

    <table class="table table-bordered">
        <tr><th>Title</th><td>{{ pr.title }}</td></tr>
        <tr><th>Description</th><td>{{ pr.description }}</td></tr>
        <tr><th>Amount</th><td>₦{{ "{:,.2f}".format(pr.amount) }}</td></tr>
        <tr><th>Status</th><td>{{ pr.status|upper }}</td></tr>

        <tr>
            <th>Vendor</th>
            <td>
                <strong>{{ pr.vendor.name }}</strong><br>
                Bank: {{ pr.vendor.bank_name }}<br>
                Account Name: {{ pr.vendor.account_name }}<br>
                Account Number: {{ pr.vendor.account_number }}
            </td>
        </tr>

        <tr>
            <th>Quotation</th>
            <td>
                {% if pr.quotation %}
                    <button
                        class="btn btn-sm btn-outline-primary preview-btn"
                        data-file="{{ url_for('static', filename='uploads/quotations/' ~ pr.quotation) }}">
                        Preview
                    </button>

                    <form method="POST"
                          action="{{ url_for('procurement.delete_quotation', request_id=pr.id) }}"
                          style="display:inline;">
                        <button class="btn btn-sm btn-danger"
                                onclick="return confirm('Delete quotation?')">
                            Delete
                        </button>
                    </form>
                {% else %}
                    <form method="POST"
                          action="{{ url_for('procurement.upload_quotation', request_id=pr.id) }}"
                          enctype="multipart/form-data">
                        <input type="file" name="quotation" required>
                        <button class="btn btn-sm btn-success">Upload</button>
                    </form>
                {% endif %}
            </td>
        </tr>
    </table>

    <hr>

    <h5>Payments</h5>

    {% if payments %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Receipt</th>
            </tr>
        </thead>
        <tbody>
            {% for p in payments %}
            <tr>
                <td>{{ p.paid_at.strftime("%d %b %Y") }}</td>
                <td>₦{{ "{:,.2f}".format(p.amount) }}</td>
                <td>{{ p.method }}</td>
                <td>
                    {% if p.receipt %}
                        <button
                            class="btn btn-sm btn-outline-secondary preview-btn"
                            data-file="{{ url_for('static', filename='uploads/receipts/' ~ p.receipt) }}">
                            Preview
                        </button>

                        <form method="POST"
                              action="{{ url_for('finance.delete_receipt', payment_id=p.id) }}"
                              style="display:inline;">
                            <button class="btn btn-sm btn-danger"
                                    onclick="return confirm('Delete receipt?')">
                                Delete
                            </button>
                        </form>
                    {% else %}
                        <form method="POST"
                              action="{{ url_for('finance.upload_receipt', payment_id=p.id) }}"
                              enctype="multipart/form-data">
                            <input type="file" name="receipt" required>
                            <button class="btn btn-sm btn-success">Upload</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <strong>Total Paid:</strong>
    ₦{{ "{:,.2f}".format(total_paid) }}

    {% else %}
        <p>No payments yet.</p>
    {% endif %}

    <hr>

    <a href="{{ url_for('finance.make_payment', request_id=pr.id) }}"
       class="btn btn-success">
        Record Payment
    </a>

    <a href="{{ url_for('procurement.list_requests') }}"
       class="btn btn-secondary">
        Back
    </a>

</div>

<!-- ===================== -->
<!-- FILE PREVIEW MODAL -->
<!-- ===================== -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">File Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="filePreviewBody" style="min-height:70vh;"></div>

    </div>
  </div>
</div>

<script>
document.querySelectorAll(".preview-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        const fileUrl = this.dataset.file;
        const body = document.getElementById("filePreviewBody");
        body.innerHTML = "";

        if (fileUrl.toLowerCase().endsWith(".pdf")) {
            body.innerHTML =
                `<iframe src="${fileUrl}" style="width:100%;height:70vh;" frameborder="0"></iframe>`;
        } else {
            body.innerHTML =
                `<img src="${fileUrl}" class="img-fluid rounded" style="max-height:70vh;">`;
        }

        new bootstrap.Modal(
            document.getElementById("filePreviewModal")
        ).show();
    });
});
</script>

{% endblock %}
