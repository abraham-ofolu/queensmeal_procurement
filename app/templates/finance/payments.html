{% extends "base.html" %}
{% block content %}

<h2>Finance Payments</h2>
<p>Finance can pay only APPROVED requests within the limit: <strong>{{ limit }}</strong></p>

<hr>

<h3>Payable Requests (Approved & Within Limit)</h3>

{% if payable_requests and payable_requests|length > 0 %}
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Item</th>
        <th>Vendor</th>
        <th>Amount</th>
        <th>Urgent</th>
        <th>Quotation</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
    {% for r in payable_requests %}
      <tr>
        <td>#{{ r.id }}</td>
        <td>{{ r.item }}</td>
        <td>
          {% if r.vendor %}
            {{ r.vendor.name }}<br>
            <small>
              {% if r.vendor.bank_name %}{{ r.vendor.bank_name }}{% endif %}
              {% if r.vendor.account_number %} - {{ r.vendor.account_number }}{% endif %}
            </small>
          {% else %}
            <em>No vendor</em>
          {% endif %}
        </td>
        <td>{{ r.amount }}</td>
        <td>{% if r.is_urgent %}✅{% else %}—{% endif %}</td>
        <td>
          {% if r.quotations and r.quotations|length > 0 %}
            <a href="{{ r.quotations[-1].file_path }}" target="_blank">View</a>
          {% else %}
            <em>None</em>
          {% endif %}
        </td>
        <td>
          <a class="btn btn-sm btn-primary" href="{{ url_for('finance.pay', request_id=r.id) }}">Pay</a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% else %}
  <p><em>No payable requests right now.</em></p>
{% endif %}

<hr>

<h3>Recent Payments</h3>
{% if recent_payments and recent_payments|length > 0 %}
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>Request</th>
        <th>Amount Paid</th>
        <th>Paid By</th>
        <th>Receipt</th>
        <th>Paid At</th>
      </tr>
    </thead>
    <tbody>
    {% for p in recent_payments %}
      <tr>
        <td>{{ p.id }}</td>
        <td>#{{ p.procurement_request_id }}</td>
        <td>{{ p.amount_paid or p.amount }}</td>
        <td>{{ p.paid_by_role }} ({{ p.paid_by_name }})</td>
        <td>
          {% if p.receipt_url %}
            <a href="{{ p.receipt_url }}" target="_blank">View</a>
          {% else %}
            <em>None</em>
          {% endif %}
        </td>
        <td>{{ p.paid_at or p.created_at }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% else %}
  <p><em>No payments recorded yet.</em></p>
{% endif %}

{% endblock %}
